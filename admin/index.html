<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JME Group Admin</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%235A8F8F'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-family='serif' font-size='18' font-weight='600' fill='%23F5F9F8'%3EJ%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Source Sans 3', sans-serif;
      font-size: 20px;
      background: #F5F9F8;
      color: #1a2e35;
      min-height: 100vh;
    }
    h1, h2, h3, h4, label { font-family: 'Fraunces', serif; color: #2a4a4a; }
    h2 { font-size: 28px; margin-bottom: 4px; }
    h3 { font-size: 22px; }
    label { display: block; font-size: 22px; margin: 18px 0 6px; }
    input, textarea, select {
      width: 100%;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 18px;
      padding: 16px;
      border: 2px solid #c8d8d4;
      border-radius: 10px;
      background: #fff;
      color: #1a2e35;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus { border-color: #3D7A7A; outline: none; box-shadow: 0 0 0 3px rgba(61,122,122,0.12); }
    textarea { resize: vertical; min-height: 100px; }
    .btn {
      font-family: 'Source Sans 3', sans-serif;
      font-size: 20px;
      font-weight: 600;
      padding: 14px 28px;
      min-height: 52px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary { background: #3D7A7A; color: #fff; }
    .btn-primary:hover { background: #2d6565; }
    .btn-primary:active { transform: scale(0.97); }

    /* ── Login ── */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #E8F0EE 0%, #F5F9F8 100%);
    }
    .login-box {
      background: #fff;
      padding: 48px 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      text-align: center;
      max-width: 440px;
      width: 90%;
    }
    .login-box h1 { font-size: 36px; color: #3D7A7A; margin-bottom: 4px; }
    .login-box .subtitle { font-size: 22px; color: #5a7a7a; margin-bottom: 32px; }
    .login-box input { margin-bottom: 20px; text-align: center; font-size: 20px; }
    .login-box .btn { width: 100%; }
    .login-error { color: #c44; font-size: 16px; margin-top: 12px; display: none; }

    /* ── Editor Layout ── */
    .editor { display: none; min-height: 100vh; }
    .sidebar {
      width: 220px;
      background: #E8F0EE;
      padding: 20px 12px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 72px;
      overflow-y: auto;
      z-index: 50;
    }
    .sidebar-logo { font-family: 'Fraunces', serif; font-size: 20px; color: #3D7A7A; padding: 4px 12px 16px; font-weight: 600; }
    .nav-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 13px 14px;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 17px;
      font-weight: 600;
      background: transparent;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: #2a4a4a;
      margin-bottom: 3px;
      transition: all 0.15s;
    }
    .nav-btn:hover { background: rgba(61,122,122,0.1); }
    .nav-btn.active { background: #3D7A7A; color: #fff; }
    .main-content {
      margin-left: 220px;
      padding: 28px 36px 100px;
      max-width: 880px;
    }
    .section-panel { display: none; }
    .section-panel.active { display: block; }
    .section-desc { color: #5a7a7a; font-size: 18px; margin-bottom: 24px; }

    /* ── Save Bar ── */
    .save-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 2px solid #E8F0EE;
      padding: 14px 36px;
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 100;
    }
    .save-bar .btn { min-width: 200px; margin-left: 220px; }
    .save-status { font-size: 18px; }
    .save-status.error { color: #c44; }
    .save-status.success { color: #3D7A7A; }

    /* ── Cards ── */
    .card {
      background: #fff;
      border: 2px solid #E8F0EE;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
    }
    .card h3 { margin-bottom: 8px; }
    .card-label { font-size: 16px; color: #5a7a7a; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }

    /* ── List Rows ── */
    .list-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .list-row input { flex: 1; }
    .btn-remove {
      background: #f0e4e4;
      color: #944;
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 52px;
      font-size: 22px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .btn-remove:hover { background: #e4d0d0; }
    .btn-add {
      background: #E8F0EE;
      color: #3D7A7A;
      border: 2px dashed #9bbebd;
      border-radius: 10px;
      padding: 12px 20px;
      font-family: 'Source Sans 3', sans-serif;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      width: 100%;
    }
    .btn-add:hover { background: #daeae6; }

    /* ── Photo Upload ── */
    .photo-upload {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 12px 0;
    }
    .photo-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #E8F0EE;
    }
    .photo-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #E8F0EE;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5a7a7a;
      font-size: 14px;
      flex-shrink: 0;
    }

    /* ── Service Expandable ── */
    .service-card .deliverables-section { display: none; padding-top: 8px; }
    .service-card.expanded .deliverables-section { display: block; }
    .service-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 4px 0;
    }
    .expand-icon {
      font-size: 28px;
      color: #3D7A7A;
      transition: transform 0.2s;
      user-select: none;
    }
    .service-card.expanded .expand-icon { transform: rotate(45deg); }

    /* ── Client Rows ── */
    .client-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .client-row input:first-child { flex: 2; }
    .client-row input:nth-child(2) { flex: 1; }

    /* ── Stat Row ── */
    .stat-row {
      display: flex;
      gap: 12px;
      align-items: end;
      margin-bottom: 8px;
    }
    .stat-row .stat-num { width: 100px; }
    .stat-row .stat-lbl { flex: 1; }

    /* ── Inline fields ── */
    .inline-fields { display: flex; gap: 12px; }
    .inline-fields > div { flex: 1; }

    /* ── Loading ── */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: #5a7a7a;
      font-size: 22px;
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #E8F0EE;
      border-top-color: #3D7A7A;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Responsive ── */
    @media (max-width: 800px) {
      .sidebar {
        position: static;
        width: 100%;
        bottom: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 12px;
      }
      .sidebar-logo { width: 100%; padding-bottom: 8px; }
      .nav-btn { width: auto; padding: 10px 14px; font-size: 15px; }
      .main-content { margin-left: 0; padding: 20px 16px 100px; }
      .save-bar .btn { margin-left: 0; }
      .inline-fields { flex-direction: column; gap: 0; }
      .client-row { flex-wrap: wrap; }
      .client-row input:first-child, .client-row input:nth-child(2) { flex: 1 1 100%; }
    }
  </style>
</head>
<body>

  <!-- ═══════════ LOGIN SCREEN ═══════════ -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h1>JME Group</h1>
      <p class="subtitle">Admin Portal</p>
      <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password">
      <button class="btn btn-primary" onclick="login()">Sign In</button>
      <p class="login-error" id="loginError">Incorrect password. Please try again.</p>
    </div>
  </div>

  <!-- ═══════════ EDITOR ═══════════ -->
  <div id="editor" class="editor">

    <!-- Sidebar Nav -->
    <div class="sidebar">
      <div class="sidebar-logo">JME Admin</div>
      <button class="nav-btn active" onclick="showSection('hero', this)">Hero</button>
      <button class="nav-btn" onclick="showSection('testimonials', this)">Testimonials</button>
      <button class="nav-btn" onclick="showSection('marquee', this)">Scrolling Bar</button>
      <button class="nav-btn" onclick="showSection('mission', this)">Mission</button>
      <button class="nav-btn" onclick="showSection('approach', this)">Our Approach</button>
      <button class="nav-btn" onclick="showSection('services', this)">Services</button>
      <button class="nav-btn" onclick="showSection('clients', this)">Who We Serve</button>
      <button class="nav-btn" onclick="showSection('about', this)">About</button>
      <button class="nav-btn" onclick="showSection('contact', this)">Contact</button>
      <button class="nav-btn" onclick="showSection('footer', this)">Footer</button>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">

      <!-- ── 1. HERO ── -->
      <div id="section-hero" class="section-panel active">
        <h2>Hero</h2>
        <p class="section-desc">The big headline visitors see first</p>
        <label>Headline Line 1</label>
        <input data-field="hero.headline.0">
        <label>Headline Line 2</label>
        <input data-field="hero.headline.1">
        <label>Headline Line 3 <span style="font-family:'Source Sans 3';font-size:16px;color:#5a7a7a">(shown in italics)</span></label>
        <input data-field="hero.headline.2">
        <label>Button Text</label>
        <input data-field="hero.cta">

        <h3 style="margin-top:28px">Background Video</h3>
        <p class="section-desc">Loops behind the headline at low opacity</p>
        <div class="photo-upload">
          <video id="hero-video-preview" style="width:120px;height:68px;object-fit:cover;border-radius:8px;border:3px solid #E8F0EE;display:none" muted loop playsinline></video>
          <div id="hero-video-placeholder" class="photo-placeholder" style="width:120px;height:68px;border-radius:8px;font-size:13px">No preview</div>
          <div>
            <input type="file" accept="video/*" onchange="handleVideoUpload(this)">
            <p style="font-size:14px;color:#5a7a7a;margin-top:4px">Max 10 MB. Will be converted to teal monochrome.</p>
          </div>
        </div>
      </div>

      <!-- ── 2. TESTIMONIALS ── -->
      <div id="section-testimonials" class="section-panel">
        <h2>Testimonials</h2>
        <p class="section-desc">Client quotes that rotate in the hero carousel</p>
        <div id="testimonials-cards"></div>
      </div>

      <!-- ── 3. SCROLLING BAR ── -->
      <div id="section-marquee" class="section-panel">
        <h2>Scrolling Bar</h2>
        <p class="section-desc">Short phrases that scroll across the page</p>
        <div id="marquee-items"></div>
        <button class="btn-add" onclick="addMarqueeItem()">+ Add Item</button>
      </div>

      <!-- ── 4. MISSION ── -->
      <div id="section-mission" class="section-panel">
        <h2>Mission</h2>
        <p class="section-desc">The heart of your message</p>
        <label>Opening Statement</label>
        <textarea data-field="mission.lead" rows="3"></textarea>
        <label>Body Paragraph 1</label>
        <textarea data-field="mission.body.0" rows="4"></textarea>
        <label>Body Paragraph 2</label>
        <textarea data-field="mission.body.1" rows="4"></textarea>

        <h3 style="margin-top:28px">Stats</h3>
        <p class="section-desc">The animated counters visitors see</p>
        <div id="mission-stats"></div>

        <h3 style="margin-top:28px">Call to Action</h3>
        <label>Question 1</label>
        <input data-field="mission.ctaQuestions.0">
        <label>Question 2</label>
        <input data-field="mission.ctaQuestions.1">
        <label>Question 3 <span style="font-family:'Source Sans 3';font-size:16px;color:#5a7a7a">(animated word-by-word)</span></label>
        <input data-field="mission.ctaQuestions.2">
        <label>Link Text</label>
        <input data-field="mission.ctaLink">
      </div>

      <!-- ── 5. OUR APPROACH ── -->
      <div id="section-approach" class="section-panel">
        <h2>Our Approach</h2>
        <p class="section-desc">How you describe your methodology</p>
        <label>Section Title</label>
        <input data-field="approach.title">
        <label>Intro Text</label>
        <input data-field="approach.intro">
        <label>Principles Lead-in</label>
        <input data-field="approach.principlesLead">

        <h3 style="margin-top:24px">Principles</h3>
        <label>Principle 1</label>
        <input data-field="approach.principles.0">
        <label>Principle 2</label>
        <input data-field="approach.principles.1">
        <label>Principle 3</label>
        <input data-field="approach.principles.2">
        <label>Principle 4</label>
        <input data-field="approach.principles.3">

        <h3 style="margin-top:28px">Pillars</h3>
        <div id="approach-pillars"></div>
      </div>

      <!-- ── 6. SERVICES ── -->
      <div id="section-services" class="section-panel">
        <h2>Services</h2>
        <p class="section-desc">Your four service areas with expandable details</p>
        <div id="services-cards"></div>
      </div>

      <!-- ── 7. WHO WE SERVE ── -->
      <div id="section-clients" class="section-panel">
        <h2>Who We Serve</h2>
        <p class="section-desc">Your client list organized by category</p>
        <div id="clients-categories"></div>
      </div>

      <!-- ── 8. ABOUT ── -->
      <div id="section-about" class="section-panel">
        <h2>About</h2>
        <p class="section-desc">Your bio and headshot</p>
        <div class="inline-fields">
          <div>
            <label>Name</label>
            <input data-field="about.name">
          </div>
          <div>
            <label>Role</label>
            <input data-field="about.role">
          </div>
        </div>
        <label>Lead Description</label>
        <textarea data-field="about.lead" rows="3"></textarea>
        <label>Bio Paragraph 1</label>
        <textarea data-field="about.bio.0" rows="4"></textarea>
        <label>Bio Paragraph 2</label>
        <textarea data-field="about.bio.1" rows="4"></textarea>
        <label>Bio Paragraph 3</label>
        <textarea data-field="about.bio.2" rows="4"></textarea>
        <label>Book Link URL</label>
        <input data-field="about.bookUrl" placeholder="e.g. doing-more-together.pdf">
        <p style="font-size:14px;color:#5a7a7a;margin-top:4px">URL for the &ldquo;Doing More Together&rdquo; link in Bio Paragraph 2. Leave empty to remove the link.</p>
        <label>Photo</label>
        <div class="photo-upload">
          <img id="about-photo-preview" class="photo-preview" src="" alt="" style="display:none">
          <div id="about-photo-placeholder" class="photo-placeholder">No photo</div>
          <div>
            <input type="file" accept="image/*" onchange="handleImageUpload(this, 'about-photo', 'images/jeanne-marie-ellis.jpg')">
            <p style="font-size:14px;color:#5a7a7a;margin-top:4px">Max 2 MB. Replaces the current headshot.</p>
          </div>
        </div>
      </div>

      <!-- ── 9. CONTACT ── -->
      <div id="section-contact" class="section-panel">
        <h2>Contact</h2>
        <p class="section-desc">How people can reach you</p>
        <label>Intro Text</label>
        <textarea data-field="contact.intro" rows="2"></textarea>
        <div class="inline-fields">
          <div>
            <label>Phone</label>
            <input data-field="contact.phone" type="tel">
          </div>
          <div>
            <label>Email</label>
            <input data-field="contact.email" type="email">
          </div>
        </div>
        <label>Location</label>
        <input data-field="contact.location">
      </div>

      <!-- ── 10. FOOTER ── -->
      <div id="section-footer" class="section-panel">
        <h2>Footer</h2>
        <p class="section-desc">The tagline at the bottom of every page</p>
        <label>Tagline</label>
        <input data-field="footer.tagline">
      </div>

    </div><!-- /main-content -->

    <!-- Save Bar -->
    <div class="save-bar">
      <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
      <span id="saveStatus" class="save-status"></span>
    </div>

  </div><!-- /editor -->

  <script>
    // ═══════════ STATE ═══════════
    let content = null;
    let pendingUploads = []; // {path, data} for images to upload on save

    // ═══════════ HELPERS ═══════════
    function escAttr(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function getPath(obj, path) {
      return path.split('.').reduce((o, k) => (o != null ? o[k] : undefined), obj);
    }

    function setPath(obj, path, val) {
      const keys = path.split('.');
      let o = obj;
      for (let i = 0; i < keys.length - 1; i++) {
        const k = isNaN(keys[i]) ? keys[i] : parseInt(keys[i]);
        o = o[k];
      }
      const last = isNaN(keys[keys.length - 1]) ? keys[keys.length - 1] : parseInt(keys[keys.length - 1]);
      o[last] = val;
    }

    function showStatus(msg, isError) {
      const el = document.getElementById('saveStatus');
      el.textContent = msg;
      el.className = 'save-status ' + (isError ? 'error' : 'success');
      if (!isError) setTimeout(() => { el.textContent = ''; }, 8000);
    }

    // ═══════════ LOGIN ═══════════
    async function login() {
      const pw = document.getElementById('passwordInput').value;
      if (!pw) return;
      sessionStorage.setItem('jme_pw', pw);
      try {
        await loadContent();
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('editor').style.display = 'block';
      } catch (e) {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    document.getElementById('passwordInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') login();
    });

    // ═══════════ LOAD CONTENT ═══════════
    async function loadContent() {
      const res = await fetch('/content.json');
      if (!res.ok) throw new Error('Failed to load content');
      content = await res.json();
      populateForms();
    }

    // ═══════════ SECTION NAV ═══════════
    function showSection(id, btn) {
      document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('section-' + id).classList.add('active');
      if (btn) btn.classList.add('active');
    }

    // ═══════════ POPULATE FORMS ═══════════
    function populateForms() {
      // Static data-field inputs
      document.querySelectorAll('[data-field]').forEach(el => {
        const val = getPath(content, el.dataset.field);
        if (val !== undefined) el.value = val;
      });
      // Dynamic sections
      renderTestimonials();
      renderMarquee();
      renderStats();
      renderPillars();
      renderServices();
      renderClients();
      renderAboutPhoto();
      renderHeroVideo();
    }

    // ═══════════ GATHER CONTENT ═══════════
    function gatherContent() {
      // Static fields
      document.querySelectorAll('[data-field]').forEach(el => {
        const val = el.type === 'number' ? Number(el.value) : el.value;
        setPath(content, el.dataset.field, val);
      });
      return content;
    }

    // ═══════════ TESTIMONIALS ═══════════
    function renderTestimonials() {
      const container = document.getElementById('testimonials-cards');
      container.innerHTML = content.testimonials.map((t, i) => {
        const photoHTML = t.photo
          ? `<img src="/${escAttr(t.photo)}" class="photo-preview" alt="">`
          : `<div class="photo-placeholder">No photo</div>`;
        return `
        <div class="card">
          <h3>Testimonial ${i + 1}</h3>
          <label>Quote</label>
          <textarea rows="3" onchange="content.testimonials[${i}].quote=this.value">${escAttr(t.quote)}</textarea>
          <div class="inline-fields">
            <div>
              <label>Name</label>
              <input value="${escAttr(t.name)}" onchange="content.testimonials[${i}].name=this.value">
            </div>
            <div>
              <label>Title</label>
              <input value="${escAttr(t.title)}" onchange="content.testimonials[${i}].title=this.value">
            </div>
          </div>
          <label>Photo</label>
          <div class="photo-upload">
            <span id="testimonial-photo-${i}">${photoHTML}</span>
            <div>
              <input type="file" accept="image/*" onchange="handleTestimonialPhoto(this, ${i})">
              <p style="font-size:14px;color:#5a7a7a;margin-top:4px">Optional. Max 2 MB. Leave empty for initials avatar.</p>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function handleTestimonialPhoto(input, index) {
      const file = input.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be under 2 MB');
        input.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1];
        const path = `images/testimonial-${index}.jpg`;
        content.testimonials[index].photo = path;
        pendingUploads = pendingUploads.filter(u => u.path !== path);
        pendingUploads.push({ path, data: base64 });
        document.getElementById(`testimonial-photo-${index}`).innerHTML =
          `<img src="${e.target.result}" class="photo-preview" alt="">`;
      };
      reader.readAsDataURL(file);
    }

    // ═══════════ MARQUEE ═══════════
    function renderMarquee() {
      const container = document.getElementById('marquee-items');
      container.innerHTML = content.marquee.map((item, i) => `
        <div class="list-row">
          <input value="${escAttr(item)}" onchange="content.marquee[${i}]=this.value" placeholder="Scrolling text...">
          <button class="btn-remove" onclick="removeMarqueeItem(${i})" title="Remove">&times;</button>
        </div>
      `).join('');
    }

    function addMarqueeItem() {
      content.marquee.push('New Item');
      renderMarquee();
    }

    function removeMarqueeItem(i) {
      if (content.marquee.length <= 1) return;
      content.marquee.splice(i, 1);
      renderMarquee();
    }

    // ═══════════ STATS ═══════════
    function renderStats() {
      const container = document.getElementById('mission-stats');
      container.innerHTML = content.mission.stats.map((s, i) => `
        <div class="stat-row">
          <div class="stat-num">
            <label style="font-size:18px">Number</label>
            <input type="number" value="${s.number}" onchange="content.mission.stats[${i}].number=Number(this.value)">
          </div>
          <div class="stat-lbl">
            <label style="font-size:18px">Label</label>
            <input value="${escAttr(s.label)}" onchange="content.mission.stats[${i}].label=this.value">
          </div>
        </div>
      `).join('');
    }

    // ═══════════ PILLARS ═══════════
    function renderPillars() {
      const container = document.getElementById('approach-pillars');
      container.innerHTML = content.approach.pillars.map((p, i) => `
        <div class="card">
          <h3>Pillar ${i + 1}</h3>
          <label>Title</label>
          <input value="${escAttr(p.title)}" onchange="content.approach.pillars[${i}].title=this.value">
          <label>Description</label>
          <textarea rows="3" onchange="content.approach.pillars[${i}].description=this.value">${escAttr(p.description)}</textarea>
        </div>
      `).join('');
    }

    // ═══════════ SERVICES ═══════════
    function renderServices() {
      const container = document.getElementById('services-cards');
      container.innerHTML = content.services.map((s, i) => {
        const deliverableRows = s.deliverables.map((d, di) => `
          <div class="list-row">
            <input value="${escAttr(d)}" onchange="content.services[${i}].deliverables[${di}]=this.value">
            <button class="btn-remove" onclick="removeDeliverable(${i},${di})" title="Remove">&times;</button>
          </div>
        `).join('');
        return `
        <div class="card service-card" id="service-card-${i}">
          <div class="service-card-header" onclick="toggleService(${i})">
            <h3>${escAttr(s.name) || 'Service ' + (i + 1)}</h3>
            <span class="expand-icon">+</span>
          </div>
          <div class="deliverables-section">
            <label>Service Name</label>
            <input value="${escAttr(s.name)}" onchange="content.services[${i}].name=this.value; this.closest('.card').querySelector('h3').textContent=this.value">
            <label>Description</label>
            <textarea rows="2" onchange="content.services[${i}].description=this.value">${escAttr(s.description)}</textarea>
            <label>List Heading</label>
            <input value="${escAttr(s.listHeading)}" onchange="content.services[${i}].listHeading=this.value">
            <label>Items</label>
            <div id="deliverables-${i}">${deliverableRows}</div>
            <button class="btn-add" onclick="addDeliverable(${i})">+ Add Item</button>
          </div>
        </div>`;
      }).join('');
    }

    function toggleService(i) {
      document.getElementById('service-card-' + i).classList.toggle('expanded');
    }

    function addDeliverable(si) {
      content.services[si].deliverables.push('');
      renderServiceDeliverables(si);
    }

    function removeDeliverable(si, di) {
      if (content.services[si].deliverables.length <= 1) return;
      content.services[si].deliverables.splice(di, 1);
      renderServiceDeliverables(si);
    }

    function renderServiceDeliverables(si) {
      const container = document.getElementById('deliverables-' + si);
      container.innerHTML = content.services[si].deliverables.map((d, di) => `
        <div class="list-row">
          <input value="${escAttr(d)}" onchange="content.services[${si}].deliverables[${di}]=this.value">
          <button class="btn-remove" onclick="removeDeliverable(${si},${di})" title="Remove">&times;</button>
        </div>
      `).join('');
    }

    // ═══════════ CLIENTS ═══════════
    function renderClients() {
      const container = document.getElementById('clients-categories');
      container.innerHTML = content.clients.map((cat, ci) => {
        const clientRows = cat.clients.map((c, i) => `
          <div class="client-row">
            <input value="${escAttr(c.name)}" onchange="content.clients[${ci}].clients[${i}].name=this.value" placeholder="Organization name">
            <input value="${escAttr(c.location)}" onchange="content.clients[${ci}].clients[${i}].location=this.value" placeholder="City, ST">
            <button class="btn-remove" onclick="removeClient(${ci},${i})" title="Remove">&times;</button>
          </div>
        `).join('');
        return `
        <div class="card">
          <label>Category Name</label>
          <input value="${escAttr(cat.category.replace(/\n/g, ' '))}" onchange="content.clients[${ci}].category=this.value">
          <label style="margin-top:16px">Clients</label>
          <div id="client-list-${ci}">${clientRows}</div>
          <button class="btn-add" onclick="addClient(${ci})">+ Add Client</button>
        </div>`;
      }).join('');
    }

    function addClient(ci) {
      content.clients[ci].clients.push({ name: '', location: '' });
      renderClientList(ci);
    }

    function removeClient(ci, i) {
      content.clients[ci].clients.splice(i, 1);
      renderClientList(ci);
    }

    function renderClientList(ci) {
      const container = document.getElementById('client-list-' + ci);
      container.innerHTML = content.clients[ci].clients.map((c, i) => `
        <div class="client-row">
          <input value="${escAttr(c.name)}" onchange="content.clients[${ci}].clients[${i}].name=this.value" placeholder="Organization name">
          <input value="${escAttr(c.location)}" onchange="content.clients[${ci}].clients[${i}].location=this.value" placeholder="City, ST">
          <button class="btn-remove" onclick="removeClient(${ci},${i})" title="Remove">&times;</button>
        </div>
      `).join('');
    }

    // ═══════════ ABOUT PHOTO ═══════════
    function renderAboutPhoto() {
      if (content.about.photo) {
        const img = document.getElementById('about-photo-preview');
        img.src = '/' + content.about.photo;
        img.style.display = 'block';
        document.getElementById('about-photo-placeholder').style.display = 'none';
      }
    }

    function renderHeroVideo() {
      const src = content.hero.videoWebm || content.hero.videoMp4;
      if (src) {
        const vid = document.getElementById('hero-video-preview');
        vid.src = '/' + src;
        vid.style.display = 'block';
        vid.play().catch(() => {});
        document.getElementById('hero-video-placeholder').style.display = 'none';
      }
    }

    function handleImageUpload(input, previewPrefix, imagePath) {
      const file = input.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be under 2 MB');
        input.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1];
        pendingUploads = pendingUploads.filter(u => u.path !== imagePath);
        pendingUploads.push({ path: imagePath, data: base64 });
        // Show preview
        const img = document.getElementById(previewPrefix + '-preview');
        img.src = e.target.result;
        img.style.display = 'block';
        const placeholder = document.getElementById(previewPrefix + '-placeholder');
        if (placeholder) placeholder.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // ═══════════ VIDEO UPLOAD ═══════════
    function handleVideoUpload(input) {
      const file = input.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        alert('Video must be under 10 MB');
        input.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1];
        const ext = file.name.split('.').pop().toLowerCase();
        const path = 'images/hero-bg.' + ext;
        const mime = ext === 'webm' ? 'video/webm' : 'video/mp4';
        pendingUploads = pendingUploads.filter(u => !u.path.startsWith('images/hero-bg.'));
        pendingUploads.push({ path, data: base64 });
        // Update content paths
        if (ext === 'webm') content.hero.videoWebm = path;
        else content.hero.videoMp4 = path;
        // Show preview
        const vid = document.getElementById('hero-video-preview');
        vid.src = e.target.result;
        vid.style.display = 'block';
        vid.play();
        document.getElementById('hero-video-placeholder').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // ═══════════ SAVE ═══════════
    async function saveChanges() {
      const pw = sessionStorage.getItem('jme_pw');
      if (!pw) {
        showStatus('Please sign in first.', true);
        return;
      }

      const btn = document.querySelector('.save-bar .btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      showStatus('', false);

      try {
        // Upload pending images first
        for (const upload of pendingUploads) {
          showStatus('Uploading image...', false);
          const res = await fetch('/.netlify/functions/upload-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw, path: upload.path, data: upload.data })
          });
          if (!res.ok) {
            if (res.status === 401) {
              showStatus('Wrong password. Please sign in again.', true);
              sessionStorage.removeItem('jme_pw');
              btn.disabled = false;
              btn.textContent = 'Save Changes';
              return;
            }
            throw new Error('Image upload failed');
          }
        }
        pendingUploads = [];

        // Save content
        const data = gatherContent();
        const res = await fetch('/.netlify/functions/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pw, content: data })
        });

        if (res.ok) {
          showStatus('Your changes are saved! The site will update in about 60 seconds.', false);
        } else if (res.status === 401) {
          showStatus('Wrong password. Please sign in again.', true);
          sessionStorage.removeItem('jme_pw');
        } else {
          throw new Error('Save failed');
        }
      } catch (e) {
        showStatus('Something went wrong. Please try again.', true);
        console.error(e);
      }

      btn.disabled = false;
      btn.textContent = 'Save Changes';
    }

    // ═══════════ INIT ═══════════
    (async function init() {
      const pw = sessionStorage.getItem('jme_pw');
      if (pw) {
        try {
          await loadContent();
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('editor').style.display = 'block';
        } catch (e) {
          // Password might be stale, show login
        }
      }
    })();
  </script>
</body>
</html>
